相比于HFGN服装推荐中的user和outfit（整套服装）的embeding是通过随机初始化得到，item（单件服装）通过预训练得到。对于论文推荐在代码上做了一些调整。在citeulike论文数据集中，与用户交互的论文和每篇论文引用的论文都是）通过预训练doc2vec得到，user是通过随机初始化得到。在训练中，将引用论文设置为不可训练的，然后通过图神经网络进行聚合。

目前在服务器上运行，因为更换为论文数据集，还有一个报错没有来得及改。

![image-20230301215802184](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230301215802184.png)

STAM: A Spatiotemporal Aggregation Method for Graph Neural Network-based Recommendation

ABSTRACT

基于图神经网络的推荐系统近年来蓬勃发展，其核心组成部分是确定邻居嵌入学习的聚合方法。以往的研究主要集中在如何从空间结构信息的角度进行信息聚合，而对邻居的时间信息的研究较少。

在这项工作中，我们提出了一种时空聚合方法STAM，以有效地将时间信息纳入邻居嵌入学习。STAM从空间结构信息和时间信息的角度生成时空邻居嵌入，促进了从空间到时空聚合方法的发展。STAM利用缩放点积注意捕获单跳邻居的时间顺序，并采用多头注意对不同潜在子空间进行联合注意。我们利用STAM进行基于gnn的推荐，以学习用户和项目嵌入。

1 INTRODUCTION

![image-20230227163808495](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227163808495.png)

在图1中，我们从用户的行为历史中选择了两个用户(Amy和Sherry)，分别为基于gnn的推荐构建了一个用户-物品二部图和一个时间顺序图。在基于空间的聚合中，Amy和Sherry的聚合邻居嵌入是相同的，因为它们与相同的项交互。与LightGCN类似，我们省略了非线性转换，并利用聚合的邻居嵌入作为单跳用户嵌入。

此图说明了两个人在不同时间预览了相同的商品，Sherry在t1 - t4时刻分别预览了ABCD四种商品，Amy在t1 - t4时刻预览了DCBA四种商品，要是按照普通GNN的方法的话，算法得到最后给两人推荐的结果是相同的，但若考虑了预览物品的先后顺序，即用STAM方法得到的两人被推荐商品并不一样。后者的推荐更为精准。


我们从用户的行为历史中收集时间信息，为某一用户-物品对(u,v)构建一个用户的时间顺序Tu = {v1，···，vS}和一个物品的时间顺序Tv = {u1，····，uS}，其中S为一跳邻居数，vt /ut记录第t个交互物品/用户。在本文中，我们利用这些时间信息改进了现有的聚集方法，促进了聚集方法从空间到时空的发展。

3 METHOD

<img src="https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227164956026.png" alt="image-20230227164956026" style="zoom:200%;" />

为了将时间信息整合到基于gnn推荐模型的聚合方法中，我们设计了一种新的用于邻居嵌入学习的时空聚合方法(STAM)。图2描述了STAM的整体架构，以时间顺序Tu和Tv为输入，输出由一跳邻居生成的时空邻居嵌入。

具体而言，我们首先为每个用户-物品对(u,v)从连接的一跳邻居中构造两个临界时间顺序，包括用户的时间顺序Tu = {v1，···，vS}和物品的时间顺序Tv = {u1，···，uS}，其中S为时间顺序长度。然后进行查找，得到每个时间顺序的初始嵌入，即时间顺序嵌入Xu = {e1v, e2v，···，eSv}和Xv = {e1u, e2u，···，eSu}。注意，初始嵌入etu和etv是从2.1节中提到的嵌入层中获得的。

STAM的首要目标是学习每个用户-物品对(u,v)的单跳邻居的时空邻居嵌入。为了实现这一目标，我们利用已成为序列建模关键部分的缩放点积注意[43]，将查询Q、键K和值V作为输入表示。查询、键和值分别通过线性投影矩阵WQ∈Rd×D '、WK∈Rd×D '和WV∈Rd×D '投影到不同的空间。此外，我们还采用位置编码[10]将时间信息编码到缩放点积注意中，即时间顺序Tu和Tv分别具有绝对时间位置嵌入Pu = {p1v, p2v，···，pSv}和Pv = {p1u, p2u，···，pSu}，其中ptu/ptv∈Rd表示位置t处的位置向量。

将时间位置嵌入Pu/Pv与时间顺序嵌入Xu/Xv相结合，得到用户和物品的时间输入嵌入Zu = {e1v + p1v, e2v + p2v，···，eSv + pSv}和Zv = {e1u + p1u, e2u + p2u，···，eSu + pSu}。这里，我们将时间输入嵌入Zu/Zv分别包装成矩阵Zu∈RS×d和Zv∈RS×d，作为STAM的输入，进行时空邻居嵌入学习。因此，以用户的时间顺序Tu为例，将缩放点积注意力函数表示为:

![image-20230227165753650](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227165753650.png)

其中Zu是时间输入嵌入矩阵，hTu∈RS×D '表示一跳邻居的输出嵌入矩阵，WQ∈Rd×D '， WK∈Rd×D '和WV∈Rd×D '是应用于每个用户-物品对(u,v)的共享权值变换。

同样，项目的时间顺序Tv的输出嵌入矩阵hTv = {h1u, h2u，····，hSu}也可以表示为:

![image-20230227165821761](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227165821761.png)

为了进一步提高STAM的表现力，我们采用了multi - head Attention而不是执行单一的注意函数，从不同的潜在角度捕捉时间信息。其中，多头注意首先将时间输入嵌入Zu/Zv投影到具有多种线性投影矩阵的k个子空间中，然后并行使用k个缩放点积注意函数生成单跳邻居的输出嵌入矩阵。这些嵌入矩阵可以被串联起来，形成一个组合的邻居嵌入矩阵。最后，应用前馈神经网络进行维数变换。

中心用户u与中心项v的时空邻居嵌入可计算为:

![image-20230227165937679](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227165937679.png)

其中hu, hv表示多头注意力产生的时空邻居嵌入，hTui /hTvi表示第i个缩放点积注意函数中单跳邻居的输出嵌入矩阵。FFN(·)可以表示为FFN(x) = xW0 + b0。注意，时空邻居嵌入也可以用时间顺序的形式表示，如hu = {hv1，···hvS}和hv = {hu1，···，huS}。

然后，利用上述时空邻居嵌入计算聚合邻居嵌入。在这里，我们简单地利用均值池操作来聚合时空邻居嵌入。在我们的实验中，我们发现用于时空邻居嵌入的均值池在总体上具有良好的性能。中心用户/项的聚合邻居嵌入nu/nv可表示为:

![image-20230227170357705](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227170357705.png)

3.2 STAM for GNN-based Recommendation

在3.1节中，我们设计了一种时空聚合方法(STAM)，从空间结构和时间顺序的角度同时学习邻居嵌入。在这里，我们利用基于gnn推荐的STAM来学习用户和项目嵌入。我们堆叠多个STAM来捕获用户-项目二部图中的高阶交互。与最先进的基于gnn的推荐模型LightGCN类似，我们也省略了非线性转换和聚合时空邻居嵌入作为中心节点嵌入。

但是，在从单跳邻居逐层传播时空邻居嵌入时，STAM的内存消耗将呈指数级增长。这里，我们从时空邻居嵌入hu/hv中学习到一个时空注意力权重矩阵Φ∈R(M+N)×(M+N)，并将其积分到邻接矩阵a∈R(M+N)×(M+N)。在数学上，时空传播层的矩阵形式可以表示为:

![image-20230227170635288](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227170635288.png)

其中h(l+1)是第(l+1)层的中心嵌入，⊙表示元素积，D是对角矩阵，其中每个元素Dii表示邻接矩阵A的第i行向量中非零元素的个数。

中心用户和项目的最终嵌入可以通过加权池化操作计算。具体来说，通过对传播的L层进行操作，将池化函数应用于生成最终的用户/物品嵌入e∗u/e∗v:

![image-20230227170813017](https://gitee.com/ning13445/picture/raw/master/picture/1/image-20230227170813017.png)

αl统一设置为1/(L + 1)

3.3 Optimization with STAM

BPR损失